from openai import OpenAI
import telebot
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏ –∏–∑ .env
load_dotenv()

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
client = OpenAI(api_key=OPENAI_API_KEY)

# üîπ –í–ø–∏—à–∏ —Å—é–¥–∞ —Å–≤–æ–π Telegram ID (—É–∑–Ω–∞–π —É @userinfobot)
ADMIN_ID = 7928610544

# üîπ –ü–∞–º—è—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_sessions = {}

# üîπ –í–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—é–º–µ)
questions = [
    "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? üòä",
    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏ üì±",
    "–ö—É–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è? üå¥",
    "–ù–∞ —Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?",
    "–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö–æ—Ç–∏—Ç–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å?",
    "–ö–∞–∫–∏–µ –¥–∞—Ç—ã –≤—ã–ª–µ—Ç–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? üìÖ"
]

# --- üî∏ ChatGPT –æ—Ç–≤–µ—Ç ---
def ask_gpt(prompt):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ChatGPT, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–≤–æ—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é"""
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": (
                        "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ "
                        "¬´–ö–û–ö–û–° –¢–£–†¬ª. –ü–æ–º–æ–≥–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç–∞–º –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ—Ç–¥—ã—Ö, —Ç—É—Ä—ã, –æ—Ç–µ–ª–∏, –≤–∏–∑—ã. "
                        "–û—Ç–≤–µ—á–∞–π –æ—Ç –∏–º–µ–Ω–∏ –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–ö–û–ö–û–° –¢–£–†¬ª ‚Äî –ø–∏—à–∏ –≤–µ–∂–ª–∏–≤–æ, –ø–æ–∑–∏—Ç–∏–≤–Ω–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ. "
                        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ —Ç—É—Ä–∏–∑–º–∞ ‚Äî –æ—Å—Ç–∞–≤–∞–π—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –Ω–∞–ø–æ–º–Ω–∏, —á—Ç–æ "
                        "–ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º: –ú–∞–ª–∏–∫ (+998774127752) "
                        "–∏ –í–ª–∞–¥–∏—Å–ª–∞–≤ (+998971779848)."
                    )
                },
                {"role": "user", "content": prompt}
            ]
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {e}"

# --- üî∏ –°—Ç–∞—Ä—Ç –æ–±—â–µ–Ω–∏—è ---
@bot.message_handler(commands=["start"])
def start(message):
    chat_id = message.chat.id
    user_sessions[chat_id] = {"step": 0, "data": {}}
    bot.send_message(
        chat_id,
        "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ ¬´–ö–û–ö–û–° –¢–£–†¬ª üå¥\n"
        "–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –¥–ª—è –≤–∞—Å –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö! üòé\n\n" + questions[0]
    )

# --- üî∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ---
@bot.message_handler(func=lambda msg: True)
def handle_message(message):
    chat_id = message.chat.id
    text = message.text.strip()

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –∑–∞—è–≤–∫–∏
    if chat_id in user_sessions:
        session = user_sessions[chat_id]
        step = session["step"]
        data = session["data"]
        data[f"q{step}"] = text
        step += 1

        if step < len(questions):
            session["step"] = step
            bot.send_message(chat_id, questions[step])
        else:
            # –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É
            name = data.get("q0", "‚Äî")
            phone = data.get("q1", "‚Äî")
            destination = data.get("q2", "‚Äî")
            people = data.get("q3", "‚Äî")
            days = data.get("q4", "‚Äî")
            dates = data.get("q5", "‚Äî")

            summary = (
                f"üìã <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:</b>\n\n"
                f"üë§ –ò–º—è: {name}\n"
                f"üì± –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
                f"üåç –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {destination}\n"
                f"üë®‚Äçüë©‚Äçüëß –ö–æ–ª-–≤–æ —á–µ–ª–æ–≤–µ–∫: {people}\n"
                f"üïí –ö–æ–ª-–≤–æ –¥–Ω–µ–π: {days}\n"
                f"üìÖ –î–∞—Ç—ã –≤—ã–ª–µ—Ç–∞: {dates}\n\n"
                f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–∑ –±–æ—Ç–∞ ¬´–ö–û–ö–û–° –¢–£–†¬ª üå¥"
            )

            #–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
            bot.send_message(ADMIN_ID, summary, parse_mode="HTML")

            # –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            bot.send_message(
                chat_id,
                f"–°–ø–∞—Å–∏–±–æ, {name}! üôè –Ø –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º. "
                "–°–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è üå¥"
            )

            # –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é
            del user_sessions[chat_id]
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞–µ—Ç—Å—è ‚Äî –æ—Ç–≤–µ—á–∞–µ–º —á–µ—Ä–µ–∑ ChatGPT
    reply = ask_gpt(text)
    bot.send_message(chat_id, reply)

print("‚úÖ –ë–æ—Ç ¬´–ö–û–ö–û–° –¢–£–†¬ª –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
bot.polling(non_stop=True)
